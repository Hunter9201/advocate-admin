<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Uganda Legal Documents ‚Äî Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- CSP that allows GitHub API + raw image previews -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  base-uri 'self';
  frame-ancestors 'none';
  connect-src 'self' https://api.github.com;
  img-src 'self' data: blob: https://raw.githubusercontent.com;
  script-src 'self' 'unsafe-inline' 'wasm-unsafe-eval' blob:;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
  font-src https://fonts.gstatic.com;
  upgrade-insecure-requests">

<meta http-equiv="Referrer-Policy" content="no-referrer"/>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{--ink:#0f172a;--muted:#64748b;--line:#e2e8f0;--brand:#1a365d;--ok:#16a34a;--bad:#c53030;--card:#fff;--bg:#f7fafc}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:12px 16px;z-index:10}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .grid{display:grid;grid-template-columns:2fr 3fr;gap:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .card .body{padding:14px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  label{font-weight:700;font-size:14px}
  input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;font-size:16px}
  .muted{color:var(--muted)}
  .button{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;font-weight:700;cursor:pointer}
  .primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .ok{background:var(--ok);border-color:var(--ok);color:#fff}
  .bad{background:var(--bad);border-color:var(--bad);color:#fff}
  .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .tag{display:inline-block;background:#1a365d0f;border:1px solid #a7c5e0;color:#1a365d;font-weight:800;padding:3px 8px;border-radius:999px}
  .small{font-size:12px}
  .preview{position:relative;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#f8fafc}
  .preview img{width:100%;height:160px;object-fit:cover;display:block;background:#f1f5f9}
  .rm{position:absolute;top:6px;right:6px;z-index:2}
  .loading{display:flex;align-items:center;justify-content:center;height:160px;color:var(--muted);font-size:14px}
  .list{display:grid;gap:8px}
  .list .item{border:1px dashed var(--line);border-radius:10px;padding:10px}
  .code{white-space:pre-wrap;word-break:break-word;background:#f8fafc;border:1px solid var(--line);padding:10px;border-radius:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;max-height:220px;overflow:auto}
  
  /* Token input modal styles */
  .token-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 16px;
    backdrop-filter: blur(2px);
    -webkit-backdrop-filter: blur(2px);
  }
  
  .token-modal {
    background: var(--card);
    border-radius: 16px;
    width: 100%;
    max-width: 400px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    border: 1px solid var(--line);
    overflow: hidden;
    max-height: 90vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  .token-modal .header {
    padding: 16px;
    border-bottom: 1px solid var(--line);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .token-modal .header h3 {
    margin: 0;
    font-size: 18px;
  }
  
  .token-modal .body {
    padding: 16px;
  }
  
  .token-modal .footer {
    padding: 16px;
    border-top: 1px solid var(--line);
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }
  
  .token-modal textarea {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 14px;
    min-height: 100px;
    resize: vertical;
  }
  
  .token-info {
    background: #f0f9ff;
    border: 1px solid #bae6fd;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 12px;
    font-size: 12px;
    color: #0369a1;
  }
  
  .categories-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin-top: 8px;
  }
  
  .category-option {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .category-option input {
    width: auto;
  }
  
  .stat-badge {
    display: inline-block;
    background: #1a365d;
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    margin-left: 6px;
  }
  
  /* PDF upload styles */
  .upload-area {
    border: 2px dashed var(--line);
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    margin: 12px 0;
    background: #f8fafc;
    cursor: pointer;
    transition: border-color 0.2s;
  }
  
  .upload-area:hover {
    border-color: var(--brand);
  }
  
  .upload-area.dragover {
    border-color: var(--ok);
    background: #f0fdf4;
  }
  
  .upload-icon {
    font-size: 36px;
    color: var(--muted);
    margin-bottom: 8px;
  }
  
  .files-preview {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-top: 16px;
  }
  
  .file-card {
    border: 1px solid var(--line);
    border-radius: 8px;
    padding: 12px;
    background: #fff;
  }
  
  .file-card.legal {
    border-left: 4px solid #1a365d;
  }
  
  .file-card.legal .file-header {
    background: #f8fafc;
    padding: 8px;
    border-radius: 6px 6px 0 0;
  }
  
  .file-card.legal .file-name {
    color: #1a365d;
    font-weight: 700;
  }
  
  .file-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
  }
  
  .file-name {
    font-weight: 600;
    font-size: 14px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
    margin-right: 8px;
  }
  
  .file-size {
    font-size: 12px;
    color: var(--muted);
  }
  
  .file-info {
    font-size: 12px;
    color: var(--muted);
    line-height: 1.4;
  }
  
  .progress-bar {
    height: 4px;
    background: var(--line);
    border-radius: 2px;
    margin-top: 8px;
    overflow: hidden;
  }
  
  .progress-fill {
    height: 100%;
    background: var(--ok);
    width: 0%;
    transition: width 0.3s;
  }
  
  /* GitHub Pages status indicator */
  .pages-status {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    margin-left: 8px;
  }
  
  .pages-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
  }
  
  .pages-dot.active {
    background-color: var(--ok);
  }
  
  .pages-dot.inactive {
    background-color: var(--muted);
  }
  
  /* Publish section styles */
  .publish-section {
    margin-top: 16px;
    padding: 12px;
    background: #f0f9ff;
    border: 1px solid #bae6fd;
    border-radius: 8px;
  }
  
  .publish-section h4 {
    margin: 0 0 8px 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .publish-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
  }
  
  .publish-checkbox input {
    width: auto;
  }
  
  /* Legal document info styles */
  .legal-doc-info {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 12px;
    margin: 12px 0;
  }
  
  .legal-doc-info h4 {
    margin: 0 0 8px 0;
    color: #1a365d;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .legal-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 8px;
    margin-top: 8px;
  }
  
  .legal-meta-item {
    display: flex;
    flex-direction: column;
  }
  
  .legal-meta-label {
    font-size: 11px;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .legal-meta-value {
    font-weight: 600;
    color: #0f172a;
  }
  
  .upload-stats {
    display: flex;
    gap: 16px;
    margin: 12px 0;
    padding: 12px;
    background: #f1f5f9;
    border-radius: 8px;
  }
  
  .stat-item {
    text-align: center;
  }
  
  .stat-number {
    font-size: 24px;
    font-weight: 700;
    color: #1a365d;
  }
  
  .stat-label {
    font-size: 12px;
    color: #64748b;
  }
  
  /* NAME DOCUMENTS SECTION */
  .name-documents-section {
    margin-top: 16px;
    background: #f8fafc;
    border: 1px solid var(--line);
    border-radius: 10px;
    padding: 16px;
  }
  
  .name-documents-section h3 {
    margin: 0 0 12px 0;
    color: var(--brand);
  }
  
  .document-name-item {
    background: white;
    border: 1px solid var(--line);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
  }
  
  .document-name-item label {
    display: block;
    font-weight: 600;
    margin-bottom: 6px;
    color: var(--muted);
    font-size: 13px;
  }
  
  .document-name-item input {
    width: 100%;
    padding: 10px;
    border: 2px solid var(--line);
    border-radius: 6px;
    font-size: 14px;
  }
  
  .document-name-item input:focus {
    border-color: var(--brand);
    outline: none;
  }
  
  .original-filename {
    font-size: 12px;
    color: var(--muted);
    margin-top: 4px;
  }
  
  @media (max-width:900px){ 
    .grid{grid-template-columns:1fr}
    .files-preview{grid-template-columns:1fr}
    .legal-meta{grid-template-columns:1fr}
  }
  @media (max-width:768px){ 
    .row{grid-template-columns:1fr}
    .categories-grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex;justify-content:space-between;align-items:center;gap:10px">
    <strong>Uganda Legal Documents ‚Äî Admin Panel</strong>
    <div class="bar">
      <button id="setTokenBtn" class="button">Set GitHub Token</button>
      <button id="setSessionBtn" class="button">Use Session</button>
      <button id="clearTokenBtn" class="button bad">Clear Token</button>
      <span id="tokenState" class="tag">No token</span>
      <span id="pagesStatus" class="pages-status" style="display:none">
        <span class="pages-dot"></span>
        <span>Pages</span>
      </span>
    </div>
  </div>
</header>

<!-- Token Input Modal -->
<div id="tokenModal" class="token-modal-overlay">
  <div class="token-modal">
    <div class="header">
      <h3>Set GitHub Token</h3>
      <button id="closeTokenModal" class="button" style="font-size: 20px; padding: 4px 10px;">√ó</button>
    </div>
    <div class="body">
      <div class="token-info">
        <strong>GitHub Personal Access Token Required</strong><br>
        Create a fine-grained token with read/write permissions for this repository. The token will be stored locally in your browser.
      </div>
      <label for="tokenInput">Paste your GitHub token:</label>
      <textarea id="tokenInput" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
      <div class="muted small" style="margin-top: 6px;">
        ‚Ä¢ Token is saved locally (or in session if enabled)<br>
        ‚Ä¢ Never share your token with anyone<br>
        ‚Ä¢ Required permissions: repo, workflow
      </div>
    </div>
    <div class="footer">
      <button id="cancelTokenBtn" class="button">Cancel</button>
      <button id="saveTokenBtn" class="button primary">Save Token</button>
    </div>
  </div>
</div>

<div class="wrap">
  <!-- CONFIG -->
  <div class="card" style="margin-bottom:12px">
    <div class="body">
      <h3 style="margin:0 0 8px">CONFIGURATION ‚Äì EDIT THESE VALUES</h3>
      <div class="row">
        <div><label>GitHub Owner</label><input id="cfgOwner" placeholder="e.g., your-username"></div>
        <div><label>GitHub Repository</label><input id="cfgRepo" placeholder="e.g., uganda-legal-docs"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div><label>Branch</label><input id="cfgBranch" placeholder="main"></div>
        <div><label>Documents JSON path</label><input id="cfgDocuments" placeholder="documents.json"></div>
      </div>
      <div class="muted small" style="margin-top:6px">
        Values are saved locally (or in session mode if enabled).<br>
        After uploading documents, they will be automatically published to: <strong>https://hunter9201.github.io/advocate/</strong>
      </div>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT: FORM -->
    <div class="card">
      <div class="body">
        <h2 id="formTitle" style="margin:0 0 10px">Upload Legal Documents <span id="editBadge" class="tag" style="display:none">Editing</span></h2>
        
        <div style="margin-bottom:12px">
          <label>Category</label>
          <div class="categories-grid">
            <div class="category-option"><input type="radio" name="category" value="constitutional" checked> Constitutional Law</div>
            <div class="category-option"><input type="radio" name="category" value="criminal"> Criminal Law</div>
            <div class="category-option"><input type="radio" name="category" value="civil"> Civil Law</div>
            <div class="category-option"><input type="radio" name="category" value="commercial"> Commercial Law</div>
            <div class="category-option"><input type="radio" name="category" value="family"> Family Law</div>
            <div class="category-option"><input type="radio" name="category" value="property"> Property Law</div>
            <div class="category-option"><input type="radio" name="category" value="evidence"> Evidence Law</div>
            <div class="category-option"><input type="radio" name="category" value="procedure"> Procedure</div>
            <div class="category-option"><input type="radio" name="category" value="judicature"> Judicature</div>
            <div class="category-option"><input type="radio" name="category" value="magistrate"> Magistrate Courts</div>
            <div class="category-option"><input type="radio" name="category" value="administrative"> Administrative Law</div>
            <div class="category-option"><input type="radio" name="category" value="employment"> Employment Law</div>
            <div class="category-option"><input type="radio" name="category" value="international"> International Law</div>
            <div class="category-option"><input type="radio" name="category" value="other"> Other Acts</div>
          </div>
        </div>

        <!-- PDF Upload Area -->
        <div class="upload-area" id="uploadArea">
          <div class="upload-icon">‚öñÔ∏è</div>
          <div><strong>Click to select legal PDF files or drag & drop here</strong></div>
          <div class="muted small">Upload up to 4 legal PDF documents at once (Max 50MB each)</div>
          <input type="file" id="pdfInput" accept=".pdf" multiple style="display:none">
        </div>

        <!-- Files Preview -->
        <div id="filesPreview" class="files-preview"></div>

        <!-- NAME DOCUMENTS SECTION -->
        <div id="nameDocumentsSection" class="name-documents-section" style="display:none">
          <h3>Name Your Documents</h3>
          <div id="documentNamesContainer">
            <!-- Document name inputs will be inserted here -->
          </div>
          <div class="muted small" style="margin-top:8px">
            Enter a name for each document. This name will appear in the document list.
          </div>
        </div>

        <!-- Auto-extracted info -->
        <div id="autoInfo" style="margin-top:16px; display:none;">
          <h4 style="margin:0 0 8px">Auto-extracted Legal Document Information</h4>
          <div class="muted small">
            Document titles, years, and legal metadata will be automatically extracted from filenames.
          </div>
        </div>

        <!-- GitHub Pages Publish Section -->
        <div id="publishSection" class="publish-section" style="display:none;">
          <h4>
            <span>üöÄ GitHub Pages Publishing</span>
            <span id="pagesIndicator" class="pages-status">
              <span class="pages-dot inactive"></span>
              <span>Checking...</span>
            </span>
          </h4>
          <div class="publish-checkbox">
            <input type="checkbox" id="autoPublish" checked>
            <label for="autoPublish"><strong>Automatically publish to https://hunter9201.github.io/advocate/</strong></label>
          </div>
          <div class="muted small">
            When enabled, legal documents will be automatically published to GitHub Pages after upload.
            You can also trigger manual publishing below.
          </div>
          <div class="bar" style="margin-top:8px">
            <button id="publishPagesBtn" class="button primary">Publish to GitHub Pages Now</button>
            <button id="checkPagesBtn" class="button">Check Status</button>
          </div>
        </div>

        <div class="bar" style="margin-top:14px">
          <button id="publishBtn" class="button primary" type="button">Upload Legal Documents</button>
          <button id="updateBtn" class="button ok" type="button" style="display:none">Update Document</button>
          <button id="resetBtn" class="button" type="button">Clear All</button>
        </div>
        <div id="status" class="muted small" style="margin-top:8px"></div>
      </div>
    </div>

    <!-- RIGHT: MANAGE -->
    <div class="card">
      <div class="body">
        <h3 style="margin:0 0 10px">Manage Legal Documents (GitHub)<span class="stat-badge" id="docCount">0</span></h3>
        <div class="bar" style="margin-bottom:8px">
          <button id="refreshBtn" class="button" type="button">Refresh List</button>
          <span style="flex:1"></span>
          <button id="exportBtn" class="button" type="button">Export JSON</button>
          <button id="importBtn" class="button" type="button">Import JSON</button>
          <input id="importInput" type="file" accept="application/json" style="display:none">
        </div>
        <div id="docList" class="list"></div>

        <h3 style="margin:16px 0 10px">GitHub Pages Status</h3>
        <div id="pagesInfo" class="list">
          <div class="item">
            <div><strong>Target URL:</strong> https://hunter9201.github.io/advocate/</div>
            <div class="muted small" id="pagesStatusText">Checking GitHub Pages status...</div>
            <div class="muted small" id="pagesLastDeployed">Last deployment: Unknown</div>
          </div>
        </div>

        <h3 style="margin:16px 0 10px">Last Action</h3>
        <div id="preview" class="list"></div>

        <h4 style="margin:14px 0 6px">Activity Log</h4>
        <div id="log" class="code"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===========================
   Uganda Legal Documents Admin Panel
   Enhanced with GitHub Pages Publishing
   =========================== */

/* --- STORAGE KEYS --- */
const TOKEN_KEY = "UGANDA_LEGAL_GH_TOKEN_V1";
const CFG_KEY   = "UGANDA_LEGAL_ADMIN_CFG_V1";
const SESSION_ONLY_KEY = "UGANDA_LEGAL_SESSION_ONLY";
const AUTO_PUBLISH_KEY = "UGANDA_LEGAL_AUTO_PUBLISH";

/* --- DEFAULT CONFIG --- */
const defaultCfg = {
  owner: "hunter9201",
  repo: "advocate",
  branch: "main",
  documentsPath: "documents.json"
};

/* --- CATEGORY MAPPING --- */
const categoryNames = {
    constitutional: "Constitutional Law",
    criminal: "Criminal Law",
    civil: "Civil Law",
    commercial: "Commercial Law",
    family: "Family Law",
    property: "Property Law",
    evidence: "Evidence Law",
    procedure: "Procedure",
    judicature: "Judicature",
    magistrate: "Magistrate Courts",
    administrative: "Administrative Law",
    employment: "Employment Law",
    international: "International Law",
    other: "Other Acts"
};

/* --- DOM REFS --- */
const tokenState = document.getElementById('tokenState');
const pagesStatus = document.getElementById('pagesStatus');
const pagesIndicator = document.getElementById('pagesIndicator');
const pagesStatusText = document.getElementById('pagesStatusText');
const pagesLastDeployed = document.getElementById('pagesLastDeployed');
const publishSection = document.getElementById('publishSection');
const autoPublishCheckbox = document.getElementById('autoPublish');
const publishPagesBtn = document.getElementById('publishPagesBtn');
const checkPagesBtn = document.getElementById('checkPagesBtn');
const setTokenBtn = document.getElementById('setTokenBtn');
const setSessionBtn = document.getElementById('setSessionBtn');
const clearTokenBtn = document.getElementById('clearTokenBtn');
const docCount = document.getElementById('docCount');

// Token modal elements
const tokenModal = document.getElementById('tokenModal');
const tokenInput = document.getElementById('tokenInput');
const closeTokenModal = document.getElementById('closeTokenModal');
const cancelTokenBtn = document.getElementById('cancelTokenBtn');
const saveTokenBtn = document.getElementById('saveTokenBtn');

const cfgOwner = document.getElementById('cfgOwner');
const cfgRepo = document.getElementById('cfgRepo');
const cfgBranch = document.getElementById('cfgBranch');
const cfgDocuments = document.getElementById('cfgDocuments');

const publishBtn = document.getElementById('publishBtn');
const updateBtn = document.getElementById('updateBtn');
const resetBtn = document.getElementById('resetBtn');
const statusEl = document.getElementById('status');
const logEl = document.getElementById('log');
const previewEl = document.getElementById('preview');

const refreshBtn = document.getElementById('refreshBtn');
const docList = document.getElementById('docList');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const importInput = document.getElementById('importInput');

const formTitle = document.getElementById('formTitle');
const editBadge = document.getElementById('editBadge');

// Upload elements
const uploadArea = document.getElementById('uploadArea');
const pdfInput = document.getElementById('pdfInput');
const filesPreview = document.getElementById('filesPreview');
const autoInfo = document.getElementById('autoInfo');

// Name documents section
const nameDocumentsSection = document.getElementById('nameDocumentsSection');
const documentNamesContainer = document.getElementById('documentNamesContainer');

/* --- STATE --- */
let editingId = null; // id being edited
let selectedFiles = []; // Array of {file, title, year, size, pages, chapterNumber, actNumber, category, description}
let customDocumentNames = {}; // Map of file index to custom name
let pagesEnabled = false;
let lastDeploymentTime = null;

/* --- HELPERS --- */
const API_BASE = "https://api.github.com";

function log(msg){ 
  const timestamp = new Date().toLocaleTimeString();
  logEl.textContent += `[${timestamp}] ${msg}\n`; 
  logEl.scrollTop = logEl.scrollHeight; 
}

function setStatus(msg){ statusEl.textContent = msg; }

function useSession(){ return sessionStorage.getItem(SESSION_ONLY_KEY) === '1'; }
function storage(){ return useSession() ? sessionStorage : localStorage; }
function saveCfg(cfg){ storage().setItem(CFG_KEY, JSON.stringify(cfg)); }
function loadCfg(){ try{ return {...defaultCfg, ...JSON.parse(storage().getItem(CFG_KEY)||"{}")}; }catch{ return {...defaultCfg}; } }
function setToken(tok){ storage().setItem(TOKEN_KEY, tok); tokenOk(); }
function getToken(){ return storage().getItem(TOKEN_KEY) || ""; }
function getAutoPublish(){ return localStorage.getItem(AUTO_PUBLISH_KEY) !== 'false'; }
function setAutoPublish(enabled){ localStorage.setItem(AUTO_PUBLISH_KEY, enabled.toString()); }

function tokenOk(stateText){
  const t = getToken();
  tokenState.textContent = stateText || (t ? (useSession()? "Token (session)":"Token set") : "No token");
  tokenState.style.background = t ? "#dcfce7" : "#1a365d0f";
  
  // Show/hide publish section based on token
  if (t) {
    publishSection.style.display = 'block';
    checkGitHubPagesStatus();
    loadAutoPublishSetting();
  } else {
    publishSection.style.display = 'none';
    pagesStatus.style.display = 'none';
  }
}

function currentCfg(){
  return {
    owner: (cfgOwner?.value || defaultCfg.owner).trim(),
    repo: (cfgRepo?.value || defaultCfg.repo).trim(),
    branch: (cfgBranch?.value || defaultCfg.branch).trim(),
    documentsPath: (cfgDocuments?.value || defaultCfg.documentsPath).trim()
  };
}

function slugify(s){ 
  return String(s||"").toLowerCase()
    .replace(/[^a-z0-9]+/g,"-")
    .replace(/^-+|-+$/g,"")
    .slice(0,50) || "document"; 
}

function toBase64Utf8(str){ return btoa(unescape(encodeURIComponent(str))); }
function fromBase64Utf8(b64){ return decodeURIComponent(escape(atob(b64.replace(/\n/g,'')))); }

function ghHeaders(){
  const h = {
    "Accept": "application/vnd.github+json",
    "X-GitHub-Api-Version": "2022-11-28"
  };
  const t = getToken();
  if (t) h["Authorization"] = "Bearer " + t;
  return h;
}

/* --- FIXED GITHUB API FUNCTIONS --- */
async function ghGetContents(path, cfg=currentCfg()){
  const url = `${API_BASE}/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(cfg.branch)}`;
  const r = await fetch(url, {headers: ghHeaders()});
  if (r.status === 404) return {status:404};
  if (!r.ok) {
    const errorText = await r.text();
    console.error(`GET ${path} failed: ${r.status}`, errorText);
    throw new Error(`GET ${path} failed: ${r.status} ${errorText}`);
  }
  return await r.json();
}

async function ghPutContents(path, base64Content, message, sha=null, cfg=currentCfg()){
  const url = `${API_BASE}/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(path)}`;
  const body = { message, content: base64Content, branch: cfg.branch };
  if (sha) body.sha = sha;
  const r = await fetch(url, { 
    method: "PUT", 
    headers: {...ghHeaders(), "Content-Type":"application/json"}, 
    body: JSON.stringify(body) 
  });
  if (!r.ok) {
    const errorText = await r.text();
    console.error(`PUT ${path} failed: ${r.status}`, errorText);
    throw new Error(`PUT ${path} failed: ${r.status} ${errorText}`);
  }
  return await r.json();
}

async function ghDeleteContents(path, message, sha, cfg=currentCfg()){
  const url = `${API_BASE}/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(path)}`;
  const r = await fetch(url, { 
    method: "DELETE", 
    headers: {...ghHeaders(), "Content-Type":"application/json"}, 
    body: JSON.stringify({ message, sha, branch: cfg.branch }) 
  });
  if (!r.ok) {
    const errorText = await r.text();
    console.error(`DELETE ${path} failed: ${r.status}`, errorText);
    throw new Error(`DELETE ${path} failed: ${r.status} ${errorText}`);
  }
  return await r.json();
}

async function uploadPDFFile(file, filename, message, cfg=currentCfg()) {
  return new Promise(async (resolve, reject) => {
    const reader = new FileReader();
    reader.onload = async () => {
      try {
        const base64 = btoa(new Uint8Array(reader.result).reduce((data, byte) => data + String.fromCharCode(byte), ''));
        
        // First, check if file already exists to get its SHA
        let existingSha = null;
        try {
          const existing = await ghGetContents(filename, cfg);
          if (existing && existing.sha) {
            existingSha = existing.sha;
            log(`File ${filename} exists with SHA: ${existingSha.substring(0, 8)}...`);
          }
        } catch (error) {
          // File doesn't exist, that's fine
          console.log(`File ${filename} doesn't exist, will create new`);
        }
        
        const result = await ghPutContents(filename, base64, message, existingSha, cfg);
        resolve(result);
      } catch (error) {
        reject(error);
      }
    };
    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  });
}

/* --- ENHANCED PDF FILENAME PARSING FOR LEGAL DOCUMENTS --- */
function extractDocumentInfoFromFilename(filename) {
  // Remove .pdf extension and clean up
  const nameWithoutExt = filename.replace(/\.pdf$/i, '')
    .replace(/_/g, ' ')
    .replace(/\[/g, ' ')
    .replace(/\]/g, ' ')
    .trim();
  
  // Common Uganda legal document patterns
  const patterns = [
    // Pattern: "Advocates Act Cap 295" or "Advocates Act [Cap. 295]"
    /^(.+?)\s+(?:Act|ACT|act)\s+(?:Cap|CAP|cap\.?|Chapter|CHAPTER|CHAP\.?)\s*\.?\s*(\d+)/i,
    
    // Pattern: "The Advocates Act Chapter 295"
    /^The\s+(.+?)\s+(?:Act|ACT|act)\s+(?:Chapter|CHAPTER|CHAP\.?)\s+(\d+)/i,
    
    // Pattern: "Advocates Act, Cap. 295"
    /^(.+?)\s+(?:Act|ACT|act)[,\s]+(?:Cap|CAP|cap\.?)\s*\.?\s*(\d+)/i,
    
    // Pattern: "Act 22 of 1970" or "Act No. 22 of 1970"
    /^(.+?)\s+(?:Act|ACT|act)\s+(?:No\.?\s*)?(\d+)\s+of\s+(\d{4})/i,
    
    // Pattern: "The Advocates Act, 1970"
    /^The\s+(.+?)\s+(?:Act|ACT|act)[,\s]+(\d{4})/i,
    
    // Pattern: "CHAPTER 295 THE ADVOCATES ACT"
    /^CHAPTER\s+(\d+)\s+THE\s+(.+?)\s+(?:Act|ACT|act)/i,
    
    // Pattern: "Cap. 295 Advocates Act"
    /^(?:Cap|CAP|cap\.?)\s*\.?\s*(\d+)\s+(.+?)\s+(?:Act|ACT|act)/i,
    
    // Generic pattern for any act with year
    /^(.+?)\s+(?:Act|ACT|act)\s+(\d{4})/i
  ];

  let title = nameWithoutExt;
  let year = new Date().getFullYear();
  let chapterNumber = null;
  let actNumber = null;
  let matchedPattern = null;

  // Try to match patterns
  for (const pattern of patterns) {
    const match = nameWithoutExt.match(pattern);
    if (match) {
      matchedPattern = pattern;
      
      // Extract information based on pattern groups
      if (pattern.toString().includes('CHAPTER')) {
        // Pattern: "CHAPTER 295 THE ADVOCATES ACT"
        chapterNumber = match[1];
        title = `The ${match[2].trim()} Act`;
      } else if (pattern.toString().includes('Cap.*\\d+.*Act')) {
        // Pattern: "Cap. 295 Advocates Act"
        chapterNumber = match[1];
        title = `${match[2].trim()} Act`;
      } else if (match[3] && match[2] && match[1]) {
        // Pattern with act number and year: "Act 22 of 1970"
        actNumber = match[2];
        year = parseInt(match[3]);
        title = `${match[1].trim()} Act`;
      } else if (match[2] && match[1]) {
        // Most common pattern: "Advocates Act Cap 295"
        if (/^\d+$/.test(match[2])) {
          // Second group is a number (chapter number)
          chapterNumber = match[2];
          title = `${match[1].trim()} Act`;
        } else if (/^\d{4}$/.test(match[2])) {
          // Second group is a year
          year = parseInt(match[2]);
          title = `${match[1].trim()} Act`;
        }
      }
      
      break;
    }
  }

  // If no pattern matched, try to extract year from any 4-digit number
  if (!matchedPattern) {
    const yearMatch = nameWithoutExt.match(/(\d{4})/);
    if (yearMatch) {
      year = parseInt(yearMatch[1]);
    }
    
    // Extract chapter/act number if present
    const numberMatch = nameWithoutExt.match(/(?:Cap|CAP|cap\.?|Chapter|CHAPTER|CHAP\.?|Act|ACT|act\s+No\.?\s*)\s*\.?\s*(\d+)/i);
    if (numberMatch) {
      chapterNumber = numberMatch[1];
    }
    
    // Format title nicely
    title = nameWithoutExt.split(/\s+(?:Act|ACT|act|Cap|CAP|cap|Chapter|CHAPTER)/i)[0];
    title = title.trim();
    if (title && !title.toLowerCase().endsWith(' act')) {
      title += ' Act';
    }
  }

  // Capitalize properly: "Advocates Act" not "ADVOCATES ACT"
  title = title.split(' ')
    .map(word => {
      if (['of', 'the', 'and', 'or', 'in', 'on', 'at', 'by'].includes(word.toLowerCase())) {
        return word.toLowerCase();
      }
      return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
    })
    .join(' ');

  // Ensure "Act" is capitalized
  title = title.replace(/\bAct\b/i, 'Act');

  // Extract category from document content analysis
  let category = extractCategoryFromTitle(title);
  
  // Generate description
  const description = generateLegalDocumentDescription(title, year, chapterNumber, actNumber);

  return {
    title: title,
    year: year,
    category: category,
    chapterNumber: chapterNumber,
    actNumber: actNumber,
    description: description,
    keywords: extractKeywordsFromTitle(title)
  };
}

function extractCategoryFromTitle(title) {
  const titleLower = title.toLowerCase();
  
  // Legal document category mapping
  const categoryMap = [
    { keywords: ['advocate', 'lawyer', 'legal practice', 'law council', 'disciplinary'], category: 'judicature' },
    { keywords: ['constitution', 'constitutional'], category: 'constitutional' },
    { keywords: ['penal', 'criminal', 'offence', 'crime'], category: 'criminal' },
    { keywords: ['civil', 'procedure', 'tort', 'contract'], category: 'civil' },
    { keywords: ['evidence'], category: 'evidence' },
    { keywords: ['company', 'commercial', 'business', 'trade'], category: 'commercial' },
    { keywords: ['family', 'marriage', 'divorce', 'children'], category: 'family' },
    { keywords: ['land', 'property', 'registration', 'conveyancing'], category: 'property' },
    { keywords: ['employment', 'labour', 'work'], category: 'employment' },
    { keywords: ['magistrate', 'court', 'judicature'], category: 'magistrate' },
    { keywords: ['administrative', 'government', 'public'], category: 'administrative' },
    { keywords: ['international', 'treaty', 'diplomatic'], category: 'international' }
  ];

  for (const mapping of categoryMap) {
    for (const keyword of mapping.keywords) {
      if (titleLower.includes(keyword)) {
        return mapping.category;
      }
    }
  }
  
  return 'other';
}

function generateLegalDocumentDescription(title, year, chapterNumber, actNumber) {
  let desc = `${title}`;
  
  if (chapterNumber) {
    desc += ` (Chapter ${chapterNumber})`;
  }
  
  if (actNumber) {
    desc += `, Act No. ${actNumber}`;
  }
  
  desc += ` of ${year}. `;
  
  // Add generic description based on category
  const category = extractCategoryFromTitle(title);
  const categoryDescriptions = {
    'constitutional': 'This constitutional law document outlines fundamental principles and rights.',
    'criminal': 'This criminal law legislation defines offences and penalties under Ugandan law.',
    'civil': 'This civil law statute governs private rights and remedies.',
    'commercial': 'This commercial law act regulates business and trade activities.',
    'family': 'This family law legislation governs marriage, divorce, and family matters.',
    'property': 'This property law statute regulates land ownership and transactions.',
    'evidence': 'This evidence law governs admissibility and procedure in legal proceedings.',
    'procedure': 'This procedural law outlines court processes and legal procedures.',
    'judicature': 'This judicature legislation regulates courts and legal practitioners.',
    'magistrate': 'This statute governs magistrate courts and their jurisdiction.',
    'administrative': 'This administrative law regulates government agencies and procedures.',
    'international': 'This international law document governs cross-border legal matters.',
    'other': 'This Ugandan legislation is part of the country\'s legal framework.'
  };
  
  desc += categoryDescriptions[category] || 'This Ugandan legislation is part of the country\'s legal framework.';
  
  return desc;
}

function extractKeywordsFromTitle(title) {
  const commonWords = ['the', 'act', 'of', 'and', 'or', 'in', 'on', 'at', 'by', 'for', 'to'];
  const words = title.toLowerCase().split(/\s+/);
  return words.filter(word => 
    word.length > 3 && !commonWords.includes(word) && !/\d/.test(word)
  ).slice(0, 5);
}

function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function createDocumentNameInputs() {
  documentNamesContainer.innerHTML = '';
  
  selectedFiles.forEach((fileData, index) => {
    const div = document.createElement('div');
    div.className = 'document-name-item';
    
    const fileName = fileData.file.name;
    const originalName = fileName.replace('.pdf', '');
    const customName = customDocumentNames[index] || originalName;
    
    div.innerHTML = `
      <label for="docName${index}">Document ${index + 1}</label>
      <input type="text" 
             id="docName${index}" 
             value="${customName}"
             placeholder="Enter document name"
             data-index="${index}">
      <div class="original-filename">Original file: ${fileName}</div>
    `;
    
    const input = div.querySelector('input');
    input.addEventListener('input', (e) => {
      customDocumentNames[index] = e.target.value.trim();
    });
    
    documentNamesContainer.appendChild(div);
  });
  
  nameDocumentsSection.style.display = 'block';
}

function handleFileSelect(files) {
  // Clear existing files
  selectedFiles = [];
  customDocumentNames = {};
  
  // Get selected category
  const categoryRadios = document.querySelectorAll('input[name="category"]');
  let selectedCategory = 'constitutional';
  categoryRadios.forEach(radio => {
    if (radio.checked) selectedCategory = radio.value;
  });
  
  // Process up to 4 files
  const fileArray = Array.from(files).slice(0, 4);
  
  fileArray.forEach(file => {
    if (file.type === 'application/pdf') {
      if (file.size > 50 * 1024 * 1024) { // 50MB limit
        alert(`File "${file.name}" is too large. Maximum size is 50MB.`);
        return;
      }
      
      // Extract basic info from filename
      const info = extractDocumentInfoFromFilename(file.name);
      
      // Create initial file data structure
      selectedFiles.push({
        file: file,
        title: info.title,
        year: info.year,
        category: selectedCategory,
        chapterNumber: info.chapterNumber,
        actNumber: info.actNumber,
        size: (file.size / (1024 * 1024)).toFixed(2),
        description: info.description,
        keywords: info.keywords
      });
    } else {
      alert(`"${file.name}" is not a PDF file. Only PDF files are allowed.`);
    }
  });
  
  updateFilesPreview();
  createDocumentNameInputs();
  
  if (selectedFiles.length > 0) {
    setStatus(`Ready to upload ${selectedFiles.length} legal document(s)`);
  }
}

function updateFilesPreview() {
  filesPreview.innerHTML = '';
  
  if (selectedFiles.length === 0) {
    autoInfo.style.display = 'none';
    nameDocumentsSection.style.display = 'none';
    return;
  }
  
  autoInfo.style.display = 'block';
  
  // Add upload stats
  const totalSize = selectedFiles.reduce((sum, f) => sum + f.file.size, 0);
  const statsDiv = document.createElement('div');
  statsDiv.className = 'upload-stats';
  statsDiv.innerHTML = `
    <div class="stat-item">
      <div class="stat-number">${selectedFiles.length}</div>
      <div class="stat-label">Documents</div>
    </div>
    <div class="stat-item">
      <div class="stat-number">${formatFileSize(totalSize)}</div>
      <div class="stat-label">Total Size</div>
    </div>
  `;
  filesPreview.appendChild(statsDiv);
  
  selectedFiles.forEach((fileData, index) => {
    const file = fileData.file;
    
    const card = document.createElement('div');
    card.className = 'file-card legal';
    
    // Use custom name if available, otherwise use extracted title
    const displayName = customDocumentNames[index] || fileData.title || file.name.replace('.pdf', '');
    
    card.innerHTML = `
      <div class="file-header">
        <div class="file-name" title="${file.name}">${displayName}</div>
        <div class="file-size">${formatFileSize(file.size)}</div>
      </div>
      <div class="file-info">
        <div><strong>File:</strong> ${file.name}</div>
        ${fileData.year ? `<div><strong>Year:</strong> ${fileData.year}</div>` : ''}
        ${fileData.chapterNumber ? `<div><strong>Chapter:</strong> ${fileData.chapterNumber}</div>` : ''}
        <div><strong>Category:</strong> ${categoryNames[fileData.category] || fileData.category}</div>
        ${fileData.description ? `<div style="margin-top:4px; font-style:italic;">${fileData.description.substring(0, 100)}...</div>` : ''}
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-${index}"></div>
      </div>
    `;
    
    filesPreview.appendChild(card);
  });
}

/* --- ENHANCED DOCUMENT ENTRY CREATION --- */
function createEnhancedDocumentEntry(fileData, filename, customName, index) {
  const now = new Date();
  
  // Use custom name if provided, otherwise use extracted title
  const documentTitle = customName || fileData.title || fileData.file.name.replace('.pdf', '');
  
  // Generate comprehensive document entry
  const document = { 
    id: 0, // Will be set later
    title: documentTitle,
    description: fileData.description || 
                `Uganda ${documentTitle}${fileData.chapterNumber ? ` (Chapter ${fileData.chapterNumber})` : ''}${fileData.year ? ` of ${fileData.year}` : ''}.`,
    filename: filename,
    category: fileData.category,
    size: fileData.size,
    pages: 0, // Could be enhanced later
    date: now.toISOString().split('T')[0],
    updated: false,
    year: fileData.year,
    chapter: fileData.chapterNumber,
    actNumber: fileData.actNumber,
    keywords: fileData.keywords,
    url: `https://hunter9201.github.io/advocate/${encodeURIComponent(filename)}`,
    metadata: {
      uploaded: now.toISOString(),
      fileType: 'pdf',
      verified: false,
      source: 'Admin Panel Upload'
    },
    // Legal document specific fields
    legalInfo: {
      jurisdiction: 'Uganda',
      documentType: 'Act',
      status: 'Current',
      amendments: [],
      commencement: fileData.year ? `${fileData.year}-01-01` : null
    }
  };
  
  return document;
}

/* --- GITHUB PAGES FUNCTIONS --- */
async function checkGitHubPagesStatus() {
  try {
    const cfg = currentCfg();
    const url = `${API_BASE}/repos/${cfg.owner}/${cfg.repo}/pages`;
    const response = await fetch(url, { headers: ghHeaders() });
    
    if (response.ok) {
      const data = await response.json();
      pagesEnabled = data.status === 'built' || data.status === 'building';
      
      // Update UI
      const dot = pagesIndicator.querySelector('.pages-dot');
      dot.className = pagesEnabled ? 'pages-dot active' : 'pages-dot inactive';
      pagesIndicator.querySelector('span:nth-child(2)').textContent = 
        pagesEnabled ? 'Pages Active' : 'Pages Inactive';
      
      pagesStatusText.textContent = pagesEnabled ? 
        `GitHub Pages is ${data.status}. Site URL: ${data.html_url || 'https://hunter9201.github.io/advocate/'}` :
        `GitHub Pages is not enabled. Enable it in repository settings.`;
      
      // Show/hide pages status in header
      pagesStatus.style.display = 'inline-flex';
      const headerDot = pagesStatus.querySelector('.pages-dot');
      headerDot.className = pagesEnabled ? 'pages-dot active' : 'pages-dot inactive';
      
      // Get deployment status
      await getLastDeployment();
      
      return pagesEnabled;
    } else {
      pagesIndicator.querySelector('.pages-dot').className = 'pages-dot inactive';
      pagesIndicator.querySelector('span:nth-child(2)').textContent = 'Pages Not Enabled';
      pagesStatusText.textContent = 'GitHub Pages is not enabled for this repository.';
      pagesEnabled = false;
      return false;
    }
  } catch (error) {
    console.error('Error checking GitHub Pages:', error);
    pagesIndicator.querySelector('.pages-dot').className = 'pages-dot inactive';
    pagesIndicator.querySelector('span:nth-child(2)').textContent = 'Error';
    pagesStatusText.textContent = 'Error checking GitHub Pages status.';
    pagesEnabled = false;
    return false;
  }
}

async function getLastDeployment() {
  try {
    const cfg = currentCfg();
    const url = `${API_BASE}/repos/${cfg.owner}/${cfg.repo}/deployments`;
    const response = await fetch(url, { headers: ghHeaders() });
    
    if (response.ok) {
      const deployments = await response.json();
      if (deployments.length > 0) {
        const latest = deployments[0];
        lastDeploymentTime = latest.created_at;
        const date = new Date(latest.created_at);
        pagesLastDeployed.textContent = `Last deployment: ${date.toLocaleString()}`;
      } else {
        pagesLastDeployed.textContent = 'Last deployment: Never deployed';
      }
    }
  } catch (error) {
    console.error('Error getting deployments:', error);
    pagesLastDeployed.textContent = 'Last deployment: Unknown';
  }
}

async function triggerGitHubPagesDeployment(message = "Deploy to GitHub Pages") {
  try {
    const cfg = currentCfg();
    
    // First, update a deployment marker file
    const deployMarkerPath = '.github/deploy-trigger.json';
    const deployMarker = {
      last_deployment: new Date().toISOString(),
      trigger: message
    };
    
    // Check if file exists
    let sha = null;
    try {
      const existing = await ghGetContents(deployMarkerPath, cfg);
      if (existing.sha) sha = existing.sha;
    } catch {
      // File doesn't exist, that's ok
    }
    
    // Create or update the marker file
    await ghPutContents(
      deployMarkerPath,
      toBase64Utf8(JSON.stringify(deployMarker, null, 2)),
      `üöÄ ${message}`,
      sha || undefined,
      cfg
    );
    
    log(`‚úì Triggered GitHub Pages deployment: ${message}`);
    return true;
  } catch (error) {
    console.error('Error triggering deployment:', error);
    log(`‚úó Failed to trigger deployment: ${error.message}`);
    return false;
  }
}

async function createGitHubPagesWorkflow() {
  try {
    const cfg = currentCfg();
    const workflowPath = '.github/workflows/deploy-to-pages.yml';
    
    const workflowContent = `name: Deploy to GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:
  repository_dispatch:
    types: [deploy-pages]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: \${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
`;

    // Check if workflow already exists
    let sha = null;
    try {
      const existing = await ghGetContents(workflowPath, cfg);
      if (existing.sha) sha = existing.sha;
    } catch {
      // File doesn't exist, that's ok
    }
    
    await ghPutContents(
      workflowPath,
      toBase64Utf8(workflowContent),
      'Add GitHub Pages deployment workflow',
      sha,
      cfg
    );
    
    log('‚úì Created/updated GitHub Pages deployment workflow');
    return true;
  } catch (error) {
    console.error('Error creating workflow:', error);
    log(`‚úó Failed to create workflow: ${error.message}`);
    return false;
  }
}

function loadAutoPublishSetting() {
  const enabled = getAutoPublish();
  autoPublishCheckbox.checked = enabled;
}

/* Token quick test */
async function verifyTokenAccess(){
  try{
    const cfg = currentCfg();
    const r = await fetch(`${API_BASE}/repos/${cfg.owner}/${cfg.repo}`, {headers: ghHeaders()});
    if (!r.ok) { 
      tokenOk("Token invalid for repo"); 
      return false; 
    }
    tokenOk("Token OK");
    await checkGitHubPagesStatus();
    return true;
  }catch(error){
    console.error('Token verification failed:', error);
    tokenOk("Token check failed");
    return false;
  }
}

/* Documents.json */
async function loadDocumentsJson(){
  try {
    const got = await ghGetContents(currentCfg().documentsPath);
    if (got.status === 404) return { arr: [], sha: null };
    const sha = got.sha;
    const text = fromBase64Utf8(got.content);
    let arr = [];
    try{ 
      arr = JSON.parse(text); 
      if(!Array.isArray(arr)) arr=[]; 
    }catch(e){ 
      log(`Warning: Could not parse documents.json: ${e.message}`);
      arr=[]; 
    }
    return { arr, sha };
  } catch (error) {
    console.error('Error loading documents.json:', error);
    return { arr: [], sha: null };
  }
}

function renderDocumentsAdmin(arr){
  if (!Array.isArray(arr) || !arr.length){
    docList.innerHTML = '<div class="muted small">No legal documents found in documents.json.</div>';
    docCount.textContent = '0';
    return;
  }
  
  docCount.textContent = arr.length;
  docList.replaceChildren();
  
  arr.forEach(doc=>{
    const item = document.createElement('div'); 
    item.className='item'; 
    item.dataset.id=doc.id;
    
    const top = document.createElement('div'); 
    top.className='bar'; 
    top.style.justifyContent='space-between'; 
    top.style.alignItems='flex-start';
    top.style.marginBottom='6px';

    const left = document.createElement('div');
    const name = document.createElement('div');
    const strong = document.createElement('strong'); 
    strong.textContent = doc.title;
    const smallId = document.createElement('span'); 
    smallId.className='muted small'; 
    smallId.textContent = ` (ID: ${doc.id})`;
    name.appendChild(strong); 
    name.appendChild(smallId);
    
    const meta = document.createElement('div'); 
    meta.className='muted small'; 
    meta.textContent = `Category: ${categoryNames[doc.category]||doc.category} ‚Ä¢ Year: ${doc.year} ‚Ä¢ Size: ${doc.size}MB`;
    if (doc.chapter) meta.textContent += ` ‚Ä¢ Chapter: ${doc.chapter}`;
    if (doc.actNumber) meta.textContent += ` ‚Ä¢ Act No.: ${doc.actNumber}`;
    
    const desc = document.createElement('div'); 
    desc.className='muted small'; 
    desc.textContent = (doc.description||'').slice(0,140);
    
    left.appendChild(name); 
    left.appendChild(meta); 
    left.appendChild(desc);

    const right = document.createElement('div'); 
    right.className='bar';
    
    const editBtn = document.createElement('button'); 
    editBtn.className='button ok'; 
    editBtn.textContent='Edit'; 
    editBtn.onclick=()=>startEdit(doc);
    
    const delBtn = document.createElement('button'); 
    delBtn.className='button bad'; 
    delBtn.textContent='Delete'; 
    delBtn.onclick=()=>deleteDocument(doc.id);
    
    right.appendChild(editBtn); 
    right.appendChild(delBtn);

    top.appendChild(left); 
    top.appendChild(right);
    item.appendChild(top);
    
    const filenameDiv = document.createElement('div'); 
    filenameDiv.className='muted small'; 
    filenameDiv.style.marginTop='4px';
    filenameDiv.textContent = `Filename: ${doc.filename}`;
    if (doc.url) {
      filenameDiv.innerHTML += ` ‚Ä¢ <a href="${doc.url}" target="_blank">View on GitHub Pages</a>`;
    }
    item.appendChild(filenameDiv);
    
    docList.appendChild(item);
  });
}

/* Editing */
function startEdit(doc){
  editingId = doc.id; 
  formTitle.textContent='Edit Legal Document'; 
  editBadge.style.display='inline-block';
  publishBtn.style.display='none'; 
  updateBtn.style.display='inline-block';
  
  // Clear file selection when editing
  selectedFiles = [];
  updateFilesPreview();
  uploadArea.style.display = 'none';
  autoInfo.style.display = 'none';
  nameDocumentsSection.style.display = 'none';
  
  // Create edit form
  const editForm = document.createElement('div');
  editForm.innerHTML = `
    <div style="margin-top:16px; background:#f0f9ff; padding:12px; border-radius:8px;">
      <h4>Edit Legal Document Details</h4>
      <div class="row">
        <div><label>Document Title</label><input id="editTitle" value="${doc.title || ''}"></div>
        <div><label>Year</label><input id="editYear" type="number" value="${doc.year || new Date().getFullYear()}"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div><label>Chapter Number</label><input id="editChapter" value="${doc.chapter || ''}" placeholder="e.g., 295"></div>
        <div><label>Act Number</label><input id="editActNumber" value="${doc.actNumber || ''}" placeholder="e.g., 22"></div>
      </div>
      <div style="margin-top:8px">
        <label>Description</label>
        <textarea id="editDesc" rows="2">${doc.description || ''}</textarea>
      </div>
      <div style="margin-top:8px">
        <label>Category</label>
        <div class="categories-grid" id="editCategories">
          ${Object.entries(categoryNames).map(([value, name]) => `
            <div class="category-option">
              <input type="radio" name="editCategory" value="${value}" ${doc.category === value ? 'checked' : ''}>
              ${name}
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;
  
  filesPreview.innerHTML = '';
  filesPreview.appendChild(editForm);
  
  window.scrollTo({top:0, behavior:'smooth'});
}

function resetForm(){
  editingId=null; 
  formTitle.textContent='Upload Legal Documents'; 
  editBadge.style.display='none';
  publishBtn.style.display='inline-block'; 
  updateBtn.style.display='none';
  
  // Reset category to constitutional
  const constitutionalRadio = document.querySelector('input[name="category"][value="constitutional"]');
  if (constitutionalRadio) constitutionalRadio.checked = true;
  
  // Clear files
  selectedFiles = [];
  customDocumentNames = {};
  updateFilesPreview();
  uploadArea.style.display = 'block';
  nameDocumentsSection.style.display = 'none';
  documentNamesContainer.innerHTML = '';
  
  setStatus('');
}

resetBtn.addEventListener('click', resetForm);

/* Update (Edit) */
updateBtn.addEventListener('click', async ()=>{
  try{
    if (!editingId){ alert('Nothing to update.'); return; }
    if (!getToken()){ alert("Set your GitHub token first."); return; }
    if (!(await verifyTokenAccess())){ alert("Token not authorized for this repo."); return; }
    
    const title = document.getElementById('editTitle')?.value?.trim();
    const year = document.getElementById('editYear')?.value;
    const chapter = document.getElementById('editChapter')?.value?.trim();
    const actNumber = document.getElementById('editActNumber')?.value?.trim();
    const description = document.getElementById('editDesc')?.value?.trim();
    const categoryRadio = document.querySelector('input[name="editCategory"]:checked');
    const category = categoryRadio ? categoryRadio.value : 'constitutional';
    
    if (!title){ alert("Enter document title."); return; }

    const cfg = currentCfg();
    setStatus("Updating legal document‚Ä¶"); 
    log(`=== Updating legal document: ${editingId} ===`);
    
    const { arr, sha } = await loadDocumentsJson();
    const idx = arr.findIndex(x=>x.id === editingId);
    if (idx === -1){ alert('Document not found.'); return; }

    const updated = { 
      ...arr[idx], 
      title: title,
      description: description || arr[idx].description,
      category: category,
      year: parseInt(year) || arr[idx].year,
      chapter: chapter || arr[idx].chapter,
      actNumber: actNumber || arr[idx].actNumber,
      updated: true
    };
    
    arr[idx] = updated;
    
    await ghPutContents(
      cfg.documentsPath, 
      toBase64Utf8(JSON.stringify(arr,null,2)), 
      `Update legal document: ${updated.title}`, 
      sha||undefined, 
      cfg
    );
    
    log("‚úì documents.json updated on GitHub");
    setStatus('Updated.');
    
    // Auto-publish to GitHub Pages if enabled
    if (getAutoPublish() && pagesEnabled) {
      setStatus("Triggering GitHub Pages deployment‚Ä¶");
      const deploymentMessage = `Update legal document: ${updated.title}`;
      await createGitHubPagesWorkflow();
      await triggerGitHubPagesDeployment(deploymentMessage);
      setStatus('Updated and deployment triggered.');
    }
    
    // Show preview
    previewEl.innerHTML = '';
    const it = document.createElement('div'); 
    it.className='item';
    it.innerHTML = `
      <div><strong>${updated.title}</strong> ‚Äî ${categoryNames[updated.category]||updated.category}</div>
      <div class="muted small">
        ${updated.year ? `Year: ${updated.year} ‚Ä¢ ` : ''}
        ${updated.chapter ? `Chapter: ${updated.chapter} ‚Ä¢ ` : ''}
        ${updated.actNumber ? `Act No.: ${updated.actNumber} ‚Ä¢ ` : ''}
      </div>
      <div class="muted small">${updated.description||''}</div>
      <div class="muted small">Filename: ${updated.filename} ‚Ä¢ Size: ${updated.size}MB</div>
      ${updated.url ? `<div class="muted small"><a href="${updated.url}" target="_blank">View on GitHub Pages</a></div>` : ''}
    `;
    previewEl.appendChild(it);

    await refreshDocumentsList();
    resetForm();
  }catch(err){ 
    console.error(err); 
    log(`Error updating document: ${err.message}`); 
    setStatus("Error: " + err.message); 
    alert("Update failed:\n" + err.message); 
  }
});

/* Delete */
async function deleteDocument(docId){
  try{
    if (!getToken()){ alert("Set your GitHub token first."); return; }
    if (!confirm(`Delete legal document ID "${docId}"? This cannot be undone.\n\nNote: This only removes the entry from documents.json. The PDF file must be deleted manually from the repository.`)) return;
    if (!(await verifyTokenAccess())){ alert("Token not authorized for this repo."); return; }

    setStatus("Deleting‚Ä¶"); 
    log(`=== Deleting legal document: ${docId} ===`);
    
    const cfg = currentCfg();
    const { arr, sha } = await loadDocumentsJson();
    const idx = arr.findIndex(p => p.id === docId);
    if (idx === -1){ alert("Document not found."); return; }
    
    const docToDelete = arr[idx];
    
    const newArr = arr.filter(p => p.id !== docId);
    await ghPutContents(
      cfg.documentsPath, 
      toBase64Utf8(JSON.stringify(newArr,null,2)), 
      `Delete legal document: ${docToDelete.title}`, 
      sha||undefined, 
      cfg
    );
    
    log(`‚úì Removed legal document ID ${docId} from documents.json`);
    setStatus("Deleted.");
    
    await refreshDocumentsList();
  }catch(err){ 
    console.error(err); 
    log(`Error deleting document: ${err.message}`); 
    setStatus("Error: " + err.message); 
    alert("Delete failed:\n" + err.message); 
  }
}

/* List / Export / Import */
async function refreshDocumentsList(){
  try{
    setStatus("Loading legal documents from GitHub‚Ä¶");
    const { arr } = await loadDocumentsJson();
    renderDocumentsAdmin(arr);
    setStatus("Ready.");
  }catch(err){
    log("Load list error: " + err.message);
    setStatus("Error loading list.");
  }
}

exportBtn.addEventListener('click', async ()=>{
  try{
    const { arr } = await loadDocumentsJson();
    const blob = new Blob([JSON.stringify(arr,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); 
    a.download = 'uganda-legal-documents-export.json'; 
    a.click();
    URL.revokeObjectURL(a.href);
  }catch(err){ 
    alert('Export failed: '+err.message); 
  }
});

importBtn.addEventListener('click', ()=> importInput.click());

importInput.addEventListener('change', async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  if(!confirm('This will replace documents.json in the repo. Continue?')) return;
  try{
    const text = await file.text();
    const data = JSON.parse(text);
    if(!Array.isArray(data)) throw new Error('JSON must be an array');
    
    // Validate document structure
    const requiredFields = ['id', 'title', 'filename', 'category'];
    data.forEach((doc, idx) => {
      requiredFields.forEach(field => {
        if (!doc.hasOwnProperty(field)) {
          throw new Error(`Document at index ${idx} missing required field: ${field}`);
        }
      });
    });
    
    const { sha } = await loadDocumentsJson();
    await ghPutContents(
      currentCfg().documentsPath, 
      toBase64Utf8(JSON.stringify(data,null,2)), 
      `Import legal documents.json`, 
      sha||undefined, 
      currentCfg()
    );
    
    alert('Imported successfully.');
    await refreshDocumentsList();
    importInput.value = '';
  }catch(err){ 
    alert('Import failed: '+err.message); 
    importInput.value = '';
  }
});

/* --- ENHANCED PUBLISH FUNCTION --- */
publishBtn.addEventListener('click', async ()=>{
  try{
    if (!getToken()){ 
      alert("Set your GitHub token first."); 
      return; 
    }
    if (selectedFiles.length === 0){ 
      alert("Please select legal PDF files to upload."); 
      return; 
    }

    // verify token once
    const ok = await verifyTokenAccess(); 
    if (!ok){ 
      alert("Token not authorized for this repo."); 
      return; 
    }

    const cfg = currentCfg();
    setStatus("Starting legal document upload process‚Ä¶"); 
    log("=== Starting legal document upload ===");
    
    // Get selected category
    const categoryRadios = document.querySelectorAll('input[name="category"]');
    let selectedCategory = 'constitutional';
    categoryRadios.forEach(radio => {
      if (radio.checked) selectedCategory = radio.value;
    });

    setStatus("Loading existing legal documents‚Ä¶");
    let arr = []; 
    let sha = null;
    try {
      const got = await ghGetContents(cfg.documentsPath, cfg);
      if (got.status !== 404){ 
        sha = got.sha; 
        try{ 
          arr = JSON.parse(fromBase64Utf8(got.content)); 
          if(!Array.isArray(arr)) arr=[]; 
        }catch(e){ 
          log(`Warning: Could not parse documents.json: ${e.message}`);
          arr=[]; 
        } 
        log(`Loaded ${arr.length} existing legal documents`); 
      }
    } catch (error) {
      log(`Error loading documents.json: ${error.message}`);
      arr = [];
    }

    // Generate new IDs
    let nextId = arr.length > 0 ? Math.max(...arr.map(d => d.id || 0)) + 1 : 1;
    
    const newDocuments = [];
    
    // Process each file with custom names
    for (let i = 0; i < selectedFiles.length; i++) {
      const fileData = selectedFiles[i];
      const file = fileData.file;
      const customName = customDocumentNames[i] || fileData.title;
      
      // Update progress
      const progressBar = document.getElementById(`progress-${i}`);
      if (progressBar) progressBar.style.width = '20%';
      
      setStatus(`Processing ${file.name} (${i+1}/${selectedFiles.length})‚Ä¶`);
      log(`Processing legal document: ${file.name}`);
      
      try {
        // Upload PDF file to GitHub
        await uploadPDFFile(
          file,
          file.name,
          `Add legal document: ${customName}${fileData.chapterNumber ? ` (Chapter ${fileData.chapterNumber})` : ''}`,
          cfg
        );
        
        if (progressBar) progressBar.style.width = '70%';
        
        // Create enhanced document entry with custom name
        const document = createEnhancedDocumentEntry(fileData, file.name, customName, i);
        document.id = nextId++;
        newDocuments.push(document);
        
        if (progressBar) progressBar.style.width = '90%';
        
        log(`‚úì Uploaded legal document: ${customName}`);
        log(`  - Category: ${categoryNames[selectedCategory]||selectedCategory}`);
        log(`  - Year: ${fileData.year}`);
        if (fileData.chapterNumber) log(`  - Chapter: ${fileData.chapterNumber}`);
        
      } catch (error) {
        log(`‚úó Failed to process ${file.name}: ${error.message}`);
        alert(`Failed to process "${file.name}". Error: ${error.message}`);
        if (progressBar) progressBar.style.width = '0%';
        return;
      }
    }
    
    // Add all new documents to array
    arr.push(...newDocuments);
    
    setStatus("Updating legal documents database‚Ä¶");
    
    // Update documents.json with pretty formatting
    await ghPutContents(
      cfg.documentsPath, 
      toBase64Utf8(JSON.stringify(arr, null, 2)), 
      `Add ${newDocuments.length} legal document(s): ${newDocuments.map(d => d.title).join(', ')}`, 
      sha||undefined, 
      cfg
    );
    
    log(`‚úì Legal documents database updated with ${newDocuments.length} new document(s)`);
    
    // Complete progress bars
    selectedFiles.forEach((_, i) => {
      const progressBar = document.getElementById(`progress-${i}`);
      if (progressBar) progressBar.style.width = '100%';
    });
    
    // Create comprehensive summary
    const summary = newDocuments.map(doc => 
      `${doc.title}${doc.chapter ? ` (Chapter ${doc.chapter})` : ''}${doc.year ? `, ${doc.year}` : ''}`
    ).join('\n‚Ä¢ ');
    
    setStatus(`Successfully uploaded ${newDocuments.length} legal document(s)!`);
    
    // Enhanced preview display
    previewEl.innerHTML = '';
    const summaryDiv = document.createElement('div'); 
    summaryDiv.className='item';
    summaryDiv.style.background = '#f0f9ff';
    summaryDiv.style.border = '2px solid #1a365d';
    summaryDiv.innerHTML = `
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
        <span style="font-size:24px;">‚öñÔ∏è</span>
        <strong style="font-size:16px;">Legal Documents Upload Summary</strong>
      </div>
      <div style="margin:8px 0; padding:8px; background:white; border-radius:6px;">
        <strong>Uploaded ${newDocuments.length} document(s):</strong>
        <div style="margin-top:4px; font-size:13px;">‚Ä¢ ${summary.replace(/\n/g, '<br>‚Ä¢ ')}</div>
      </div>
    `;
    previewEl.appendChild(summaryDiv);
    
    // Show individual documents
    newDocuments.forEach(doc => {
      const it = document.createElement('div'); 
      it.className='item';
      it.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
          <div>
            <strong>${doc.title}</strong>
            <div class="muted small">
              ${categoryNames[doc.category]||doc.category} ‚Ä¢ 
              ${doc.year ? `Year: ${doc.year}` : ''}${doc.chapter ? ` ‚Ä¢ Chapter: ${doc.chapter}` : ''}
              ${doc.actNumber ? ` ‚Ä¢ Act No.: ${doc.actNumber}` : ''}
            </div>
          </div>
        </div>
        <div class="muted small" style="margin-top:4px;">${doc.description||''}</div>
        <div class="muted small" style="margin-top:4px;">
          <strong>Filename:</strong> ${doc.filename} ‚Ä¢ 
          <strong>Size:</strong> ${doc.size}MB
        </div>
        <div class="muted small" style="margin-top:4px;">
          <a href="${doc.url}" target="_blank">üìÑ View on GitHub Pages</a>
        </div>
      `;
      previewEl.appendChild(it);
    });

    // Auto-publish to GitHub Pages
    if (getAutoPublish() && pagesEnabled) {
      setStatus("Publishing to GitHub Pages‚Ä¶");
      log("=== Publishing legal documents to GitHub Pages ===");
      
      const deploymentMessage = `Publish ${newDocuments.length} legal document(s)`;
      
      await createGitHubPagesWorkflow();
      const deployed = await triggerGitHubPagesDeployment(deploymentMessage);
      
      if (deployed) {
        const successMsg = document.createElement('div');
        successMsg.className = 'item';
        successMsg.style.background = '#f0fdf4';
        successMsg.style.borderColor = '#16a34a';
        successMsg.innerHTML = `
          <div style="display:flex; align-items:center; gap:8px;">
            <span style="font-size:20px;">üöÄ</span>
            <strong>GitHub Pages Deployment Successful</strong>
          </div>
          <div style="margin:8px 0;">
            <div class="muted small">Your legal documents are being published to:</div>
            <div style="margin:4px 0;">
              <a href="https://hunter9201.github.io/advocate/" target="_blank" style="color:#1a365d; font-weight:bold;">
                https://hunter9201.github.io/advocate/
              </a>
            </div>
          </div>
          <div class="muted small">
            Documents will be available in 1-2 minutes. You can view them at the URL above.
          </div>
        `;
        previewEl.prepend(successMsg);
        
        setStatus(`Legal documents published! Available at: https://hunter9201.github.io/advocate/`);
      }
    }
    
    await refreshDocumentsList();
    resetForm();
    
  }catch(err){ 
    console.error(err); 
    log(`Error uploading legal documents: ${err.message}`); 
    setStatus("Upload failed: " + err.message); 
    alert("Failed to upload legal documents:\n" + err.message); 
  }
});

/* --- EVENT LISTENERS FOR NEW FEATURES --- */
autoPublishCheckbox.addEventListener('change', (e) => {
  setAutoPublish(e.target.checked);
  log(`Auto-publish ${e.target.checked ? 'enabled' : 'disabled'}`);
});

publishPagesBtn.addEventListener('click', async () => {
  try {
    if (!getToken()) {
      alert("Set your GitHub token first.");
      return;
    }
    
    setStatus("Triggering GitHub Pages deployment‚Ä¶");
    
    // Check if GitHub Pages is enabled
    const pagesEnabled = await checkGitHubPagesStatus();
    if (!pagesEnabled) {
      alert("GitHub Pages is not enabled for this repository. Enable it in the repository settings first.");
      return;
    }
    
    // Ensure workflow exists
    await createGitHubPagesWorkflow();
    
    // Trigger deployment
    const success = await triggerGitHubPagesDeployment("Manual deployment triggered from admin panel");
    
    if (success) {
      setStatus("GitHub Pages deployment triggered successfully!");
      alert("GitHub Pages deployment triggered successfully! Your site will be updated shortly at https://hunter9201.github.io/advocate/");
      
      // Update last deployment time
      await getLastDeployment();
    } else {
      setStatus("Failed to trigger deployment.");
      alert("Failed to trigger GitHub Pages deployment. Check the logs for details.");
    }
  } catch (error) {
    console.error('Error triggering deployment:', error);
    setStatus("Error: " + error.message);
    alert("Failed to trigger deployment: " + error.message);
  }
});

checkPagesBtn.addEventListener('click', async () => {
  setStatus("Checking GitHub Pages status‚Ä¶");
  await checkGitHubPagesStatus();
  setStatus("GitHub Pages status updated.");
});

/* File upload event listeners */
uploadArea.addEventListener('click', () => {
  pdfInput.click();
});

pdfInput.addEventListener('change', (e) => {
  if (e.target.files.length > 4) {
    alert('Maximum 4 files allowed. Only the first 4 will be processed.');
  }
  handleFileSelect(e.target.files);
});

// Drag and drop support
uploadArea.addEventListener('dragover', (e) => {
  e.preventDefault();
  uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', (e) => {
  e.preventDefault();
  uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadArea.classList.remove('dragover');
  
  if (e.dataTransfer.files.length > 0) {
    if (e.dataTransfer.files.length > 4) {
      alert('Maximum 4 files allowed. Only the first 4 will be processed.');
    }
    handleFileSelect(e.dataTransfer.files);
  }
});

/* --- TOKEN MODAL FUNCTIONS --- */
function showTokenModal() {
  tokenModal.style.display = 'flex';
  tokenInput.value = '';
  setTimeout(() => {
    tokenInput.focus();
    tokenModal.scrollTop = 0;
  }, 100);
}

function hideTokenModal() {
  tokenModal.style.display = 'none';
  tokenInput.value = '';
}

async function saveTokenFromModal() {
  const token = tokenInput.value.trim();
  if (!token) {
    alert("Please enter a GitHub token.");
    return;
  }
  
  setToken(token);
  hideTokenModal();
  
  setStatus("Testing token‚Ä¶");
  const ok = await verifyTokenAccess();
  setStatus(ok ? "Token OK" : "Token invalid for repo");
}

/* Token / Session buttons */
setTokenBtn.addEventListener('click', showTokenModal);

setSessionBtn.addEventListener('click', ()=>{
  if(confirm('Use sessionStorage? Your token will clear when you close the tab.')){
    sessionStorage.setItem(SESSION_ONLY_KEY,'1');
    const localTok = localStorage.getItem(TOKEN_KEY);
    if(localTok){ 
      sessionStorage.setItem(TOKEN_KEY, localTok); 
      localStorage.removeItem(TOKEN_KEY); 
    }
    tokenOk();
  }
});

clearTokenBtn.addEventListener('click', ()=>{
  localStorage.removeItem(TOKEN_KEY);
  sessionStorage.removeItem(TOKEN_KEY);
  sessionStorage.removeItem(SESSION_ONLY_KEY);
  tokenOk("No token");
});

/* Token modal event listeners */
closeTokenModal.addEventListener('click', hideTokenModal);
cancelTokenBtn.addEventListener('click', hideTokenModal);
saveTokenBtn.addEventListener('click', saveTokenFromModal);

// Close modal when clicking outside of it
tokenModal.addEventListener('click', (e) => {
  if (e.target === tokenModal) {
    hideTokenModal();
  }
});

// Handle Escape key to close modal
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && tokenModal.style.display === 'flex') {
    hideTokenModal();
  }
});

/* --- INITIALIZATION --- */
(function initCfg(){
  const cfg = loadCfg();
  cfgOwner.value = cfg.owner;
  cfgRepo.value = cfg.repo;
  cfgBranch.value = cfg.branch;
  cfgDocuments.value = cfg.documentsPath;
  
  // Check if token exists and show publish section
  if (getToken()) {
    publishSection.style.display = 'block';
    loadAutoPublishSetting();
  }
})();

// Initialize event listeners for config changes
[cfgOwner,cfgRepo,cfgBranch,cfgDocuments].forEach(el=>{
  el.addEventListener('change', ()=> saveCfg(currentCfg()));
});

/* --- STARTUP --- */
tokenOk();
refreshBtn.addEventListener('click', refreshDocumentsList);
refreshDocumentsList();

// Check GitHub Pages status on startup if token exists
if (getToken()) {
  setTimeout(() => checkGitHubPagesStatus(), 1000);
}

/* Initial message */
log("Uganda Legal Documents Admin Panel initialized");
log("Set your GitHub token to start managing legal documents.");
log("Legal documents will be automatically published to: https://hunter9201.github.io/advocate/");
</script>
</body>
</html>
